<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Timer</title>
    <style>
        body {
            text-align: center;
            background-image: url('./bg.png');
            background-size: cover;
        }

        .container {
            height: 100vh;
            height: 100dvh;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid black;
            background-color: rgba(0, 0, 0, 0.8);
        }

        h1 {
            color: white;
            font-size: 30em;
            font-size: 30vi;
            font-family: Arial, Helvetica, sans-serif;;
        }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
    <script>
        var params = window.location.hash.substring(1)?.split('&');
        var pTime = 0, pPin = null;
        var timeLabel;
        var mqttClient;
        var timer;
        
        window.addEventListener('load', function () {
            params.forEach(param => {
                var value = param.split('=');
                switch (value[0]){
                    case "t":
                        pTime = parseInt(value[1])
                        break;
                    case "pin":
                        pPin = value[1];
                        break;
                }
            })
            console.log('Params: T: ' + pTime +' | PIN: ' + pPin)
            
            timeLabel = document.getElementById('timeLbl');
            timeLabel.innerHTML = pTime;

            acquireWakeLock();
            setupMQTT();
        })
        
        async function acquireWakeLock(){
            try{
                await navigator.wakeLock.request('screen');
            }catch (e){
                alert("WakeLock failed. " + e)
            }
        }
        
        function setupMQTT(){
            if (pPin == null)
                return;
            
            const cId = "ifs-web-" + new Date().getTime();
            mqttClient = new Paho.MQTT.Client("broker.hivemq.com", 8884, cId);
            mqttClient.onConnectionLost = onConnectionLost;
            mqttClient.onMessageArrived = onMessageArrived;
            console.log("MQTT CLIENT: " + cId);

            connect();
        }

        function connect(p = "CONNECTING"){
            console.log("MQTT " + p + "...");
            mqttClient.connect({onSuccess:onConnect, useSSL:true});
        }
        
        function onConnect() {
            console.log('MQTT CONNECTED');
            var topic = "3f191e8fbbe6aff775b68c5f538d9c5c/"+pPin;
            mqttClient.subscribe(topic);
            console.log('MQTT SUBSCRIBED -> T: ' + topic);
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.error("MQTT DISCONNECTED: "+responseObject.errorMessage);
            }
            connect("RECONNECTING");
        }

        function onMessageArrived(message) {
            if (message == null)
                return;
            var payload = message.payloadString;
            console.log("MQTT -> " + payload);
            
            switch (payload){
                case "start":
                    start();
                    break;
                case "stop":
                    stop();
                    break;
                case "reset":
                    reset();
                    break;
            }
        }
        
        function start() {
            if (timer != null)
                return;
            
            stop()
            if (timeLabel.innerHTML <= 0)
                return;

            if (--timeLabel.innerHTML > 0)
                timer = setInterval(function (){
                    if (--timeLabel.innerHTML <= 0)
                        stop()
                }, 1000);
        }

        function reset() {
            stop()
            timeLabel.innerHTML = pTime;
            timer = setInterval(function (){
                if (--timeLabel.innerHTML <= 0)
                    stop()
            }, 1000);
        }

        function stop() {
            clearInterval(timer);
            timer = null;
        }
    </script>
</head>
<body>
    <div class="container">
        <h1 id="timeLbl">?</h1>
    </div>
</body>
</html>